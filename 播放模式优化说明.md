# 豆包TTS插件播放模式优化

## 问题分析

原有的插件在分句播放时存在衔接问题：
- **串行播放**：播放完一句后才请求下一句，导致音频间隙
- **网络延迟**：每句话都要等待TTS API响应
- **用户体验差**：分句之间有明显的停顿

## 解决方案

### 1. 三段式并发播放（HTTP模式）

实现"播放一句，准备一句，请求一句"的并发机制：

```
时间线：
句子1: [请求] → [准备] → [播放]
句子2:         [请求] → [准备] → [播放]  
句子3:                 [请求] → [准备] → [播放]
```

**核心特性：**
- 音频队列管理：预加载最多3句音频
- 并发请求控制：避免同时发起过多请求
- 无缝播放：当前句播放时，下一句已准备就绪
- 错误处理：单句失败不影响整体播放

### 2. WebSocket流式播放

针对WebSocket模式，实现整段文本流式传输：

**优势：**
- **整段传输**：不需要分句，一次性传输完整帖子内容
- **流式播放**：服务端流式返回音频数据，语音更连贯
- **减少请求**：每篇帖子只需一次WebSocket连接
- **更好体验**：消除分句间的停顿

## 配置选项

### 1. 播放模式选择
- **WebSocket模式**：整段流式播放，语音最连贯
- **HTTP模式 + 三段式并发**：分句播放但无缝衔接
- **HTTP模式 + 串行播放**：传统模式，兼容性最好

### 2. 智能显示
- WebSocket模式下自动隐藏并发模式选项
- 根据音色类型动态显示相关配置
- 提供详细的模式说明

## 技术实现

### 核心函数

1. **readNextSentenceWithQueue()** - 三段式并发播放
2. **preloadAudioQueue()** - 音频预加载管理
3. **readWithWebSocketMode()** - WebSocket整段播放
4. **updateConcurrentModeVisibility()** - UI智能显示

### 状态管理

```javascript
// 三段式并发相关变量
let audioQueue = [];           // 音频队列
let isRequestingAudio = false; // 请求状态控制
let maxQueueSize = 3;          // 最大预加载数量
```

### WebSocket协议

- 支持豆包TTS的二进制WebSocket协议
- 处理流式音频数据接收和拼接
- 完整的错误处理和超时机制

## 使用建议

1. **推荐配置**：
   - 长文本：WebSocket模式
   - 短文本：HTTP模式 + 三段式并发
   - 网络不稳定：HTTP模式 + 串行播放

2. **性能优化**：
   - WebSocket模式适合完整阅读场景
   - 三段式并发适合快速浏览场景
   - 可根据网络状况动态调整

## 兼容性

- 保持与原有功能完全兼容
- 默认启用三段式并发模式
- 支持所有豆包TTS音色和情感参数
- 向后兼容原有的串行播放模式
